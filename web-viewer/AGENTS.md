# GLOQ Floorplan Viewer - React Frontend

An interactive TestFit-style web application for viewing and editing floor plans generated by the GLOQ Massing Solver.

## Project Overview

This is an **interactive building massing visualization tool** built with React 19, TypeScript, and Vite. It provides a TestFit-style UI for viewing and editing floor plans generated by the GLOQ Massing Solver. The viewer displays building floor plans with polygon-based spaces, real-time metrics, vertex editing capabilities, and integrated map views.

### Key Features

- **Interactive Floor Navigation**: Browse floors with dark-themed navigation
- **Polygon Editor**: Drag vertices, add/remove points, undo/redo support
- **Pan & Zoom**: Canvas navigation with mouse wheel and drag
- **Real-time Metrics**: Live floor efficiency, area calculations, violations
- **Space Search**: Filter and search spaces by name or type
- **Map Integration**: Parcel map view with Leaflet
- **Collapsible Panels**: Focus mode with toggleable side panels
- **Keyboard Shortcuts**: Full keyboard navigation support
- **Dark Theme**: Professional dark UI with purple accents

## Project Structure

```
web-viewer/
├── src/
│   ├── components/
│   │   ├── floorplan/          # Floor plan visualization
│   │   │   ├── EditableFloorPlanViewer.tsx  # SVG canvas with pan/zoom
│   │   │   ├── FloorNavigation.tsx          # Floor selector
│   │   │   └── FloorPlanViewer.tsx          # Read-only viewer
│   │   ├── editor/             # Polygon editing tools
│   │   │   ├── PolygonEditor.tsx     # Vertex/edge overlay
│   │   │   ├── VertexHandle.tsx      # Draggable vertex points
│   │   │   └── EdgeHandle.tsx        # Edge midpoint for adding vertices
│   │   ├── panels/             # Side panels & UI
│   │   │   ├── SpaceDetailsPanel.tsx   # Selected space properties
│   │   │   ├── MetricsDashboard.tsx    # Building/solver metrics
│   │   │   ├── MetricsBar.tsx          # Bottom status bar
│   │   │   ├── LegendPanel.tsx         # Space type color legend
│   │   │   ├── SpaceSearch.tsx         # Search/filter spaces
│   │   │   └── ExtractedBuildingView.tsx  # 3D building render
│   │   ├── toolbar/
│   │   │   └── CanvasToolbar.tsx   # Tool modes, undo/redo
│   │   ├── map/
│   │   │   └── ParcelMap.tsx       # Leaflet map integration
│   │   ├── verification/
│   │   │   └── VerificationCalculator.tsx  # Constraint validation
│   │   └── data/
│   │       └── PdfUploader.tsx     # PDF upload interface
│   ├── hooks/                  # Custom React hooks
│   │   ├── usePolygonEditor.ts   # Vertex editing + history
│   │   ├── useFloorNavigation.ts # Floor index management
│   │   ├── useFloorMetrics.ts    # Real-time metrics
│   │   ├── useSolverData.ts      # Data loading
│   │   └── useSpaceSelection.ts  # Space selection state
│   ├── types/
│   │   └── solverOutput.ts       # TypeScript interfaces (mirrors Python)
│   ├── utils/
│   │   ├── geometry.ts           # SVG coordinate transforms
│   │   ├── polygon.ts            # Area, centroid calculations
│   │   ├── geocoding.ts          # Address lookup
│   │   └── generateFromExtracted.ts  # PDF extraction utilities
│   ├── constants/
│   │   └── colors.ts             # Space type color definitions
│   ├── App.tsx                 # Main application component
│   ├── App.css                 # Global styles
│   └── main.tsx                # Entry point
├── functions/                  # Firebase Cloud Functions (Node 18)
│   └── index.js
├── public/data/                # Pre-computed solver outputs
│   ├── p1_building.json        # Building input
│   ├── p1_output.json          # Solver output
│   ├── p4_*, p7_*, p9_*        # Additional projects
├── dist/                       # Build output
├── vite.config.ts              # Vite configuration
├── tsconfig.json               # TypeScript configuration
├── firebase.json               # Firebase hosting config
└── package.json                # Dependencies and scripts
```

## Component Reference

### Floor Plan (`components/floorplan/`)

| Component | Purpose | Key Props |
|-----------|---------|-----------|
| `FloorPlanViewer.tsx` | Read-only floor plan rendering | `floor`, `scale`, `showLabels` |
| `EditableFloorPlanViewer.tsx` | Interactive floor plan with editing | `floor`, `editableSpaces`, `selectedSpaceId`, `editMode`, `onVertexMove` |
| `FloorNavigation.tsx` | Floor selector with navigation arrows | `floorIndices`, `currentFloorIndex`, `currentFloorType`, `onFloorChange` |

### Polygon Editor (`components/editor/`)

| Component | Purpose | Key Props |
|-----------|---------|-----------|
| `PolygonEditor.tsx` | Main polygon editing overlay | `space`, `editMode`, `onVertexMove`, `onVertexAdd` |
| `VertexHandle.tsx` | Draggable vertex control point | `position`, `onDrag`, `onRemove` |
| `EdgeHandle.tsx` | Mid-edge control for adding vertices | `startPos`, `endPos`, `onAdd` |

### Panels (`components/panels/`)

| Component | Purpose | Key Props |
|-----------|---------|-----------|
| `SpaceDetailsPanel.tsx` | Selected space properties | `space`, `onClose` |
| `MetricsDashboard.tsx` | Solver metrics display | `solverMetrics`, `buildingMetrics`, `success` |
| `MetricsBar.tsx` | Bottom status bar with floor metrics | `efficiency`, `totalSpaces`, `violations` |
| `LegendPanel.tsx` | Space type color legend | (none) |
| `SpaceSearch.tsx` | Search/filter spaces by name | `spaces`, `onSpaceSelect`, `selectedSpaceId` |
| `ExtractedBuildingView.tsx` | Display extracted building data | `buildingData` |

## Custom Hooks (`hooks/`)

| Hook | Purpose | Returns |
|------|---------|---------|
| `useSolverData.ts` | Load/manage solver JSON data | `solverResult`, `buildingInput`, `loading`, `loadProject`, `availableProjects` |
| `useFloorNavigation.ts` | Floor selection state | `currentFloorIndex`, `currentFloor`, `goToFloor`, `nextFloor`, `prevFloor` |
| `useFloorMetrics.ts` | Calculate floor-level metrics | `efficiency`, `usableArea`, `violations`, `areaDelta` |
| `useSpaceSelection.ts` | Track selected space | `selectedSpace`, `selectSpace`, `clearSelection` |
| `usePolygonEditor.ts` | Polygon editing + undo/redo | `editableSpaces`, `moveVertexTo`, `addVertex`, `removeVertexAt`, `undo`, `redo` |

## TypeScript Types (`types/solverOutput.ts`)

Mirrors Python Pydantic schemas from `schemas/solver_output.py`:

```typescript
// Core types
interface SolverResult { success, obstruction, iterations, metrics, building }
interface BuildingData { floors, stalks, metrics }
interface FloorData { floor_index, floor_type, boundary, spaces }
interface SpaceData { id, type, name, geometry, membership, area_deviation }

// Geometry (supports rectangle and polygon)
type Geometry = RectGeometry | PolygonGeometry;
interface RectGeometry { x, y, width, height, rotation }
interface PolygonGeometry { vertices: [number, number][] }

// Type guards
function isPolygonGeometry(geom): geom is PolygonGeometry
function isRectGeometry(geom): geom is RectGeometry
function rectToPolygon(rect): [number, number][]
```

## Data Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│  public/data/*.json (or Firebase)                                   │
└────────────────────────┬────────────────────────────────────────────┘
                         ↓
┌────────────────────────┴────────────────────────────────────────────┐
│  useSolverData.ts                                                    │
│  - Fetches and parses SolverResult JSON                             │
│  - Manages project selection state                                   │
└────────────────────────┬────────────────────────────────────────────┘
                         ↓
┌────────────────────────┴────────────────────────────────────────────┐
│  App.tsx (main coordinator)                                          │
│  - useFloorNavigation → current floor state                         │
│  - usePolygonEditor → editable spaces + history                     │
│  - useSpaceSelection → selected space for details panel             │
│  - useFloorMetrics → efficiency, violations, etc.                   │
└────────────────────────┬────────────────────────────────────────────┘
                         ↓
┌────────────────────────┴────────────────────────────────────────────┐
│  EditableFloorPlanViewer.tsx                                         │
│  - Renders SVG floor plan with spaces                               │
│  - Handles click → space selection                                  │
│  - Handles drag → vertex editing                                    │
│  - Shows hover effects, labels, boundaries                          │
└─────────────────────────────────────────────────────────────────────┘
```

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Escape` | Deselect current space |
| `Arrow Up` | Previous floor |
| `Arrow Down` | Next floor |
| `V` | View mode |
| `E` | Edit vertices mode |
| `H` | Add vertices (edge) mode |
| `A` | Select mode |
| `M` | Move space mode |
| `Ctrl+Z` | Undo |
| `Ctrl+Y` / `Ctrl+Shift+Z` | Redo |

## Running the Viewer

```bash
# Install dependencies
cd web-viewer
npm install

# Development server
npm run dev
# Opens at http://localhost:5173

# Build for production
npm run build

# Preview production build
npm run preview
```

## Conventions

### File Organization
- **Components**: One component per file, named exports
- **Hooks**: Prefixed with `use`, return tuples or objects
- **Types**: Interfaces mirror Python Pydantic models
- **Utils**: Pure functions, no side effects

### SVG Rendering
- **World Coordinates**: Y-up, origin at center (feet)
- **SVG Coordinates**: Y-down, origin at top-left
- **Transform**: `createSvgTransform` handles conversion
- **Scale**: Default 3x (world units to pixels)

### Styling
- **CSS Variables**: Design tokens (`--bg-primary`, `--accent`, etc.)
- **BEM-ish Naming**: `.floor-plan-container`, `.panel-header`
- **Dark Theme**: Default, no light mode
- **Accent Color**: Purple (#a78bfa)

## Making Changes

### Adding a New Space Type
1. Add color in `constants/colors.ts`
2. Update `LegendPanel.tsx` if needed
3. **Sync with Python**: Ensure `schemas/solver_output.py` includes the type

### Adding a New Panel
1. Create component in `components/panels/`
2. Import and add to `App.tsx` layout
3. Add CSS styles if needed

### Adding a New Tool Mode
1. Add mode to `EditMode` type in `usePolygonEditor.ts`
2. Update `CanvasToolbar.tsx` with new button
3. Handle mode in `EditableFloorPlanViewer.tsx` or `PolygonEditor.tsx`

### Changing Data Schema
1. Update TypeScript types in `types/solverOutput.ts`
2. **Sync with Python**: Ensure `schemas/solver_output.py` matches
3. Update hooks that consume the data

### Adding New Project Data
1. Add `px_building.json` and `px_output.json` to `public/data/`
2. Update `availableProjects` in `useSolverData.ts`

## Debugging Tips

- **SVG Inspection**: Browser DevTools Elements tab
- **State Debugging**: React DevTools hooks inspection
- **Coordinate Issues**: Check `createSvgTransform` scale and offset
- **Performance**: Memoize with `useMemo`, `useCallback`

## UI/UX Features

### Completed (Phases 1-3)
- Hover effects with glow on spaces
- Toolbar tooltips with keyboard shortcuts
- Dark-themed floor navigation with floor type labels
- Collapsible side panels with toggle buttons
- Space search and filter by type
- Loading skeleton UI with shimmer animation
- Auto-hide labels at low zoom (<0.7x)
- Zoom level indicator
- Improved status indicators (INCOMPLETE vs FAILED)

### Planned (Phase 4)
- Multi-select spaces (Shift+click)
- Export functionality (PNG/SVG/PDF)
- Mini-map overview

## Deployment

```bash
# Build and deploy to Firebase
npm run build
firebase deploy --only hosting

# Deploy functions only
cd functions
npm run deploy
```

## Dependencies

### Core
- `react: ^19.2.0` - UI framework
- `typescript: ~5.9.3` - Type safety
- `vite: ^7.2.4` - Build tool

### Mapping
- `leaflet: ^1.9.4` - Map rendering
- `react-leaflet: ^5.0.0` - React bindings

### PDF
- `pdfjs-dist: ^5.4.449` - PDF parsing

### Firebase
- `firebase: ^11.6.1` - Backend services
- `firebase-functions: ^6.3.2` - Cloud functions
