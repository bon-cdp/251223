# GLOQ Floorplan Viewer

## Project Overview

This is an **interactive building massing visualization tool** built with React, TypeScript, and Vite. It provides a TestFit-style UI for viewing and editing floor plans generated by the GLOQ Massing Solver. The viewer displays building floor plans with polygon-based spaces, real-time metrics, vertex editing capabilities, and integrated map views.

### Key Features

- **Interactive Floor Navigation**: Browse between floors with real-time metrics
- **Polygon Editor**: Drag vertices, add/remove points, visual feedback
- **Pan & Zoom**: Canvas navigation with mouse wheel and drag gestures
- **Real-time Metrics**: Live floor efficiency, area calculations, violations tracking
- **Map Integration**: Parcel map view with Leaflet
- **Multi-project Support**: Switch between different building projects
- **Dark Theme**: TestFit-inspired professional dark UI

## Architecture

```
web-viewer/
├── src/
│   ├── App.tsx               # Main app with 4-panel layout
│   ├── App.css               # Global dark theme styles
│   ├── components/
│   │   ├── floorplan/        # Floor plan rendering
│   │   │   ├── EditableFloorPlanViewer.tsx  # SVG canvas with pan/zoom
│   │   │   ├── FloorNavigation.tsx          # Floor list navigation
│   │   │   └── FloorPlanViewer.tsx          # Read-only viewer
│   │   ├── editor/           # Polygon editing UI
│   │   │   ├── PolygonEditor.tsx     # Vertex/edge overlay
│   │   │   ├── VertexHandle.tsx      # Draggable vertex points
│   │   │   └── EdgeHandle.tsx        # Edge midpoint for adding vertices
│   │   ├── panels/           # Side panel components
│   │   │   ├── SpaceDetailsPanel.tsx   # Selected space properties
│   │   │   ├── MetricsDashboard.tsx    # Building/solver metrics
│   │   │   ├── MetricsBar.tsx          # Bottom status bar
│   │   │   ├── LegendPanel.tsx         # Space type color legend
│   │   │   └── ExtractedBuildingView.tsx  # 3D-style building render
│   │   ├── toolbar/
│   │   │   └── CanvasToolbar.tsx   # Edit mode controls, undo/redo
│   │   ├── map/
│   │   │   └── ParcelMap.tsx       # Leaflet map integration
│   │   ├── verification/
│   │   │   └── VerificationCalculator.tsx  # Input vs output validation
│   │   └── data/
│   │       └── ProjectLoader.tsx   # Project data management
│   ├── hooks/
│   │   ├── usePolygonEditor.ts   # Vertex editing state machine
│   │   ├── useFloorNavigation.ts # Floor index management
│   │   ├── useFloorMetrics.ts    # Real-time metric calculations
│   │   ├── useSolverData.ts      # Project data loading
│   │   └── useSpaceSelection.ts  # Space click selection
│   ├── types/
│   │   └── solverOutput.ts       # TypeScript interfaces for solver JSON
│   └── utils/
│       ├── geometry.ts           # SVG coordinate transforms
│       ├── polygon.ts            # Polygon calculations (area, centroid)
│       ├── geocoding.ts          # Address to lat/lng lookup
│       └── generateFromExtracted.ts  # PDF extraction utilities
├── public/
│   └── data/                     # Sample project JSON files
│       ├── p1_building.json      # Building input specification
│       ├── p1_output.json        # Solver output with placed spaces
│       └── ...                   # More project examples
└── firebase.json                 # Firebase hosting config
```

## Key Patterns

### Data Flow

```
public/data/*.json → useSolverData() → App.tsx
                          ↓
    [SolverResult, BuildingInput]
                          ↓
    ┌─────────────────────┼─────────────────────┐
    ↓                     ↓                     ↓
FloorNavigation    EditableFloorPlanViewer   Panels
    ↓                     ↓
useFloorNavigation   usePolygonEditor
```

### Polygon Editing Architecture

The viewer uses a vertex-based polygon editor with undo/redo support:

```typescript
// From usePolygonEditor.ts - state machine for editing
export type EditMode = 'select' | 'vertex' | 'edge-add';

// Spaces track editable vertices separately from original
interface EditableSpaceData extends SpaceData {
  editableVertices?: [number, number][];
  hasChanges?: boolean;
  hasCollision?: boolean;
}
```

### Geometry Handling

The viewer supports both rectangle and polygon geometry formats:

```typescript
// Type guards for geometry discrimination
function isPolygonGeometry(geom: Geometry): geom is PolygonGeometry {
  return 'vertices' in geom;
}

// SVG coordinate system: Y-up world → Y-down screen
function createSvgTransform(scale: number, offset: Position) {
  return { worldToSvg: (x, y) => [x * scale + offset.x, -y * scale + offset.y] };
}
```

### Component State Management

- **Local Component State**: Zoom, pan, selection (React useState)
- **Hooks for Domain Logic**: Floor navigation, polygon editing, metrics
- **Props for Data Flow**: Unidirectional data from App to child components

## Running the Viewer

```bash
# Development server
npm run dev

# Production build
npm run build

# Preview production build
npm run preview
```

Visit `http://localhost:5173` after starting the dev server.

## Conventions

### File Organization

- **Components**: One component per file, named exports
- **Hooks**: Custom hooks prefixed with `use`, return tuples or objects
- **Types**: Interfaces in `types/` mirror Python Pydantic models
- **Utils**: Pure functions, no side effects

### Styling

- **CSS Variables**: Design tokens in `:root` (`--bg-primary`, `--accent`, etc.)
- **BEM-ish Naming**: `.floor-plan-container`, `.panel-header`
- **Dark Theme**: Default dark palette, no light mode toggle

### SVG Rendering

- **World Coordinates**: Spaces use Y-up, origin at center
- **SVG Coordinates**: Y-down, origin at top-left
- **Transform**: `createSvgTransform` handles coordinate conversion
- **Scale**: Default 3x (world units to pixels)

## Adding New Features

### New Panel Component

1. Create component in `src/components/panels/NewPanel.tsx`
2. Import and add to `App.tsx` in `.properties-panel` section
3. Style in `App.css` or component's own CSS file

### New Edit Mode

1. Add mode to `EditMode` type in `usePolygonEditor.ts`
2. Handle mode in `EditableFloorPlanViewer.tsx` event handlers
3. Add toolbar button in `CanvasToolbar.tsx`

### New Project Data

1. Add `px_building.json` and `px_output.json` to `public/data/`
2. Update `availableProjects` in `useSolverData.ts`

## Debugging Tips

- **SVG Inspection**: Browser DevTools Elements tab shows all paths/shapes
- **State Debugging**: React DevTools hooks inspection
- **Coordinate Issues**: Check `createSvgTransform` scale and offset
- **Performance**: Memoize heavy computations with `useMemo`

## Deployment

The viewer deploys to Firebase Hosting:

```bash
# Build and deploy
npm run build
firebase deploy --only hosting
```

Output directory is `dist/`, configured in `firebase.json`.
